<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Pot of Gold - Mobile Ready</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        #gameWrapper {
            width: 100%;
            max-width: 900px;
            height: 100vh;
            max-height: 800px;
            position: relative;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            #gameWrapper {
                max-width: 100%;
                max-height: 100vh;
                box-shadow: none;
            }
        }

        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-tips {
            position: absolute;
            bottom: 100px;
            color: white;
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
            padding: 0 20px;
        }

        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        #mainMenu.hidden {
            display: none;
        }

        /* Daily Challenge Banner */
        .daily-challenge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.3);
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
        }

        .daily-challenge-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .daily-challenge-progress {
            width: 150px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .daily-challenge-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.3s;
        }

        /* Tutorial Overlay */
        #tutorialOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9000;
        }

        #tutorialOverlay.active {
            display: flex;
        }

        .tutorial-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: white;
        }

        .tutorial-title {
            color: #FFD700;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .tutorial-steps {
            text-align: left;
            margin: 20px 0;
        }

        .tutorial-step {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutorial-step-icon {
            font-size: 24px;
        }

        /* Game Container */
        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            display: none;
            flex-direction: column;
        }

        #gameContainer.active {
            display: flex;
        }

        /* Header with combo display */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
        }

        /* Combo Display */
        #comboDisplay {
            position: absolute;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            animation: comboPopup 0.3s ease-out;
            z-index: 1001;
        }

        #comboDisplay.active {
            display: block;
        }

        @keyframes comboPopup {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Power-up Inventory */
        #powerupInventory {
            position: absolute;
            top: 70px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }

        .powerup-slot {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #FFD700;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .powerup-slot:active {
            transform: scale(0.95);
        }

        .powerup-slot-icon {
            font-size: 20px;
        }

        .powerup-slot-count {
            font-size: 10px;
            color: #FFD700;
            font-weight: bold;
        }

        /* Achievement Popup */
        #achievementPopup {
            position: fixed;
            top: 70px;
            right: 10px;
            transform: translateX(0);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            animation: slideInRight 0.3s ease-out;
            z-index: 2001;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            font-size: 11px;
            max-width: 180px;
            opacity: 0.9;
        }

        #achievementPopup.active {
            display: block;
        }

        @keyframes slideInRight {
            0% { transform: translateX(120%); opacity: 0; }
            100% { transform: translateX(0); opacity: 0.9; }
        }
        
        @keyframes achievementBounce {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* Game Canvas */
        #gameCanvas {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 100px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><defs><linearGradient id="sky" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%2387CEEB"/><stop offset="100%" style="stop-color:%23E0F6FF"/></linearGradient></defs><rect width="800" height="600" fill="url(%23sky)"/><ellipse cx="150" cy="550" rx="200" ry="80" fill="%2390EE90" opacity="0.8"/><ellipse cx="650" cy="550" rx="200" ry="80" fill="%2390EE90" opacity="0.8"/><rect x="0" y="500" width="800" height="100" fill="%238B7355"/><g id="tracks"><rect x="50" y="520" width="700" height="3" fill="%23654321"/><rect x="50" y="540" width="700" height="3" fill="%23654321"/><g id="ties"><rect x="100" y="515" width="8" height="35" fill="%235C4033"/><rect x="200" y="515" width="8" height="35" fill="%235C4033"/><rect x="300" y="515" width="8" height="35" fill="%235C4033"/><rect x="400" y="515" width="8" height="35" fill="%235C4033"/><rect x="500" y="515" width="8" height="35" fill="%235C4033"/><rect x="600" y="515" width="8" height="35" fill="%235C4033"/><rect x="700" y="515" width="8" height="35" fill="%235C4033"/></g></g></svg>') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }

        /* Mobile Touch Areas - Improved */
        .touch-area {
            position: absolute;
            top: 60px;
            bottom: 100px;
            width: 33.33%;
            z-index: 10;
            opacity: 0;
        }

        #leftTouch {
            left: 0;
        }

        #centerTouch {
            left: 33.33%;
        }

        #rightTouch {
            right: 0;
        }

        /* Visual touch feedback */
        .touch-indicator {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            display: none;
            animation: touchPulse 0.3s ease-out;
        }

        @keyframes touchPulse {
            from {
                transform: scale(0.5);
                opacity: 1;
            }
            to {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Cart */
        #cart {
            position: absolute;
            bottom: 100px;
            width: 70px;
            height: 60px;
            background: linear-gradient(135deg, #8B4513, #A0522D);
            border: 3px solid #654321;
            border-radius: 10px 10px 20px 20px;
            transition: left 0.1s ease-out;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        #cart.state-flag {
            background: linear-gradient(135deg, #002868, #BF0A30);
            border-color: #FFD700;
        }
        
        #cart.special-edition {
            background: linear-gradient(135deg, #9B59B6, #E74C3C);
            border-color: #FFD700;
            animation: specialGlow 2s infinite;
        }
        
        @keyframes specialGlow {
            0%, 100% { box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 4px 20px rgba(255,215,0,0.6); }
        }

        /* Collection Effect */
        .collect-effect {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            pointer-events: none;
            animation: collectFloat 1s ease-out forwards;
            z-index: 200;
        }

        @keyframes collectFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(1.5);
                opacity: 0;
            }
        }

        /* Falling Items */
        .falling-item {
            position: absolute;
            width: 30px;
            height: 30px;
            font-size: 24px;
            animation: fall linear;
            z-index: 50;
        }

        @keyframes fall {
            to {
                transform: translateY(calc(100vh - 60px));
            }
        }

        /* Bottom Menu - Mobile Optimized */
        #bottomMenu {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px;
            z-index: 100;
        }

        .menu-btn {
            flex: 1;
            max-width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 2px solid #FFD700;
            border-radius: 12px;
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .menu-btn:active {
            transform: scale(0.95);
        }

        .menu-btn-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FF0000;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
        }

        /* Shop Modal - Enhanced */
        #shopModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #shopModal.active {
            display: flex;
        }

        .shop-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-preview {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .shop-preview-cart {
            font-size: 48px;
            margin: 10px 0;
        }

        /* Stats Modal */
        #statsModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #statsModal.active {
            display: flex;
        }

        .stats-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            border-radius: 20px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            color: white;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-label {
            color: #FFD700;
        }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            .menu-title { font-size: 28px; }
            .menu-button { font-size: 14px; padding: 10px 20px; }
            .stat { font-size: 11px; padding: 3px 6px; }
            .menu-btn { max-width: 55px; height: 55px; font-size: 9px; }
            .menu-btn .icon { font-size: 16px; }
            
            #powerupInventory {
                top: 110px;
            }
            
            .powerup-slot {
                width: 40px;
                height: 40px;
            }
        }

        /* Prevent scrolling on mobile */
        @media (max-width: 768px) {
            body {
                position: fixed;
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="gameWrapper">
        <!-- Loading Screen -->
        <div id="loadingScreen">
            <div class="loading-content">
                <div style="font-size: 64px;">üçØ</div>
                <h1 style="color: #FFD700; font-size: 32px; margin: 20px 0;">Pot of Gold</h1>
                <div class="loading-spinner"></div>
            </div>
            <div class="loading-tips">
                <p id="loadingTip">Tip: Collect combos for bonus points!</p>
            </div>
        </div>

        <!-- Tutorial Overlay -->
        <div id="tutorialOverlay">
            <div class="tutorial-content">
                <h2 class="tutorial-title">How to Play</h2>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <span class="tutorial-step-icon">üëÜ</span>
                        <span>Tap left or right to move the cart</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-icon">ü™ô</span>
                        <span>Collect coins and treasures</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-icon">üí£</span>
                        <span>Avoid bombs and rocks</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-icon">üßπ</span>
                        <span>Use power-ups to clear blocked paths</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="tutorial-step-icon">üî•</span>
                        <span>Build combos for multipliers!</span>
                    </div>
                </div>
                <button class="menu-button" id="closeTutorial" style="width: 100%;">Got it!</button>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="hidden">
            <!-- Daily Challenge -->
            <div class="daily-challenge">
                <div class="daily-challenge-title">Daily Challenge</div>
                <div id="dailyChallengeText">Collect 100 coins</div>
                <div class="daily-challenge-progress">
                    <div class="daily-challenge-fill" id="dailyProgress" style="width: 0%"></div>
                </div>
            </div>

            <div class="user-info" id="userInfo" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; color: white;">
                <div style="color: #FFD700; font-weight: bold;" id="displayUsername">Guest</div>
                <div style="font-size: 12px;">
                    <div>Best: <span id="bestScore">0</span></div>
                    <div>Coins: <span id="totalCoins">0</span></div>
                </div>
            </div>
            
            <div style="font-size: 64px;">üçØ</div>
            <h1 style="color: #FFD700; font-size: 36px; margin: 10px 0;">Pot of Gold</h1>
            <p style="color: white; opacity: 0.9; margin-bottom: 30px;">Catch the falling treasures!</p>
            
            <div style="display: flex; flex-direction: column; gap: 12px; width: 280px; max-width: 90%;">
                <button class="menu-button" id="playBtn" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a2e; border: none; padding: 12px; border-radius: 25px; font-weight: bold;">Play Game</button>
                <button class="menu-button" id="proBtn" style="background: linear-gradient(135deg, #9B59B6, #E74C3C); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; position: relative;">
                    ‚≠ê Go Pro - 2x Coins & Exclusive Drops!
                    <span style="position: absolute; top: -5px; right: 10px; background: #FFD700; color: #333; padding: 2px 6px; border-radius: 10px; font-size: 10px;">NEW</span>
                </button>
                <button class="menu-button" id="profileBtn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px; border-radius: 25px;">üë§ My Collection</button>
                <button class="menu-button" id="statsBtn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px; border-radius: 25px;">Statistics</button>
                <button class="menu-button" id="tutorialBtn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px; border-radius: 25px;">How to Play</button>
            </div>
        </div>

        <!-- Game Container -->
        <div id="gameContainer">
            <div id="header">
                <div id="stats" style="display: flex; gap: 8px; align-items: center;">
                    <div class="stat" style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 15px; color: white; font-size: 12px;">üí∞ <span id="coins">0</span></div>
                    <div class="stat" style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 15px; color: white; font-size: 12px;">‚≠ê <span id="score">0</span></div>
                    <div class="stat" style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 15px; color: white; font-size: 12px;">üéØ <span id="level">1</span></div>
                    <div class="stat" style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 15px; color: white; font-size: 12px;">‚ù§Ô∏è <span id="lives">3</span></div>
                    <div id="proBadge" style="display: none; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 4px 8px; border-radius: 15px; color: #333; font-size: 11px; font-weight: bold;">PRO ‚≠ê</div>
                </div>
                <button id="pauseBtn" style="width: 45px; height: 45px; background: rgba(0,0,0,0.5); border: 2px solid #FFD700; border-radius: 50%; color: white; font-size: 20px;">‚è∏Ô∏è</button>
            </div>

            <!-- Combo Display -->
            <div id="comboDisplay">
                <span id="comboText">Combo x2!</span>
            </div>

            <!-- Power-up Inventory -->
            <div id="powerupInventory">
                <div class="powerup-slot" id="shieldSlot">
                    <span class="powerup-slot-icon">üõ°Ô∏è</span>
                    <span class="powerup-slot-count">0</span>
                </div>
                <div class="powerup-slot" id="magnetSlot">
                    <span class="powerup-slot-icon">üß≤</span>
                    <span class="powerup-slot-count">0</span>
                </div>
                <div class="powerup-slot" id="doubleSlot">
                    <span class="powerup-slot-icon">x2</span>
                    <span class="powerup-slot-count">0</span>
                </div>
            </div>

            <!-- Achievement Popup -->
            <div id="achievementPopup">
                <span style="font-size: 16px;">üèÜ</span>
                <span id="achievementName" style="font-size: 11px; margin-left: 5px;">First Coin!</span>
            </div>

            <div id="gameCanvas">
                <div id="cart">üçØ</div>
                
                <!-- Touch Areas for Mobile -->
                <div id="leftTouch" class="touch-area"></div>
                <div id="centerTouch" class="touch-area"></div>
                <div id="rightTouch" class="touch-area"></div>
                
                <!-- Touch Indicator -->
                <div class="touch-indicator" id="touchIndicator"></div>
            </div>

            <div id="bottomMenu">
                <button class="menu-btn" id="streakBtn">
                    <span class="icon" style="font-size: 18px;">üî•</span>
                    <span>Streak</span>
                    <span class="menu-btn-badge" id="streakBadge" style="display: none;">!</span>
                </button>
                <button class="menu-btn" id="seasonBtn">
                    <span class="icon" style="font-size: 18px;">üèÜ</span>
                    <span>Pass</span>
                    <span class="menu-btn-badge" id="seasonBadge" style="display: none;">!</span>
                </button>
                <button class="menu-btn" id="shopBtn">
                    <span class="icon" style="font-size: 18px;">üõçÔ∏è</span>
                    <span>Shop</span>
                    <span class="menu-btn-badge" id="shopBadge" style="display: none;">!</span>
                </button>
                <button class="menu-btn" id="skinBtn">
                    <span class="icon" style="font-size: 18px;" id="skinIcon">üé®</span>
                    <span>Skin</span>
                </button>
                <button class="menu-btn" id="vacuumBtn">
                    <span class="icon" style="font-size: 18px;">üå™Ô∏è</span>
                    <span>Vacuum</span>
                    <span style="font-size: 9px; color: #FFD700;">25üí∞</span>
                </button>
                <button class="menu-btn" id="clearBtn">
                    <span class="icon" style="font-size: 18px;">üí•</span>
                    <span>Clear All</span>
                    <span style="font-size: 9px; color: #FFD700;">50üí∞</span>
                </button>
            </div>
        </div>

        <!-- Shop Modal -->
        <div id="shopModal">
            <div class="shop-content">
                <div style="display: flex; justify-content: space-between; align-items: center; color: #FFD700; margin-bottom: 20px;">
                    <h2>üõçÔ∏è SHOP</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px;">
                            üí∞ <span id="shopCoins">${game.coins || 0}</span>
                        </div>
                        <button id="buyCoinsBtn" style="background: linear-gradient(135deg, #00C851, #00FF00); color: #333; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 12px;">
                            üí≥ Buy Coins
                        </button>
                        <button id="closeShopBtn" style="background: none; border: none; color: white; font-size: 24px;">‚úñÔ∏è</button>
                    </div>
                </div>
                
                <!-- Shop Preview -->
                <div class="shop-preview">
                    <div>Preview</div>
                    <div class="shop-preview-cart" id="shopPreviewCart">üçØ</div>
                    <div style="color: #FFD700; font-size: 14px;">Classic Pot</div>
                </div>
                
                <div id="shopItems" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- Shop items will be added here -->
                </div>
            </div>
        </div>

        <!-- Skin Selector Modal -->
        <div id="skinModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 3000;">
            <div style="background: linear-gradient(135deg, #1a1a2e, #0f0f1e); border-radius: 20px; padding: 20px; max-width: 500px; width: 90%; max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #FFD700; margin: 0;">üé® Select Cart Skin</h2>
                    <button id="closeSkinBtn" style="background: #FF0000; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï</button>
                </div>
                
                <div id="currentSkinDisplay" style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px;" id="currentSkinIcon">üçØ</div>
                    <div style="color: #FFD700; margin-top: 10px;">Current Skin</div>
                </div>
                
                <div id="ownedSkins" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <!-- Owned skins will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile/Collection Modal -->
        <div id="profileModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 3000;">
            <div style="background: linear-gradient(135deg, #1a1a2e, #0f0f1e); border-radius: 20px; padding: 20px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #FFD700; margin: 0;">üèÜ My Collection</h2>
                    <button id="closeProfileBtn" style="background: #FF0000; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- Collection Progress -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    <div style="color: white; font-size: 14px; margin-bottom: 10px;">Collection Progress</div>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 20px; overflow: hidden;">
                        <div id="collectionProgress" style="height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 0%; transition: width 1s ease;"></div>
                    </div>
                    <div style="color: #FFD700; font-size: 12px; margin-top: 5px; text-align: center;">
                        <span id="collectionCount">0</span> / <span id="collectionTotal">0</span> Items Collected
                    </div>
                </div>
                
                <!-- Cart Skins Collection -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #FFD700; font-size: 16px; margin-bottom: 10px;">üõí Cart Skins</h3>
                    <div id="cartCollection" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <!-- Cart display cases will be added here -->
                    </div>
                </div>
                
                <!-- State Flags Collection -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #FFD700; font-size: 16px; margin-bottom: 10px;">üá∫üá∏ State Collection</h3>
                    <div id="stateCollection" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <!-- State display cases will be added here -->
                    </div>
                </div>
                
                <!-- Special Edition Collection -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #FFD700; font-size: 16px; margin-bottom: 10px;">‚ú® Special Editions</h3>
                    <div id="specialCollection" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <!-- Special display cases will be added here -->
                    </div>
                </div>
                
                <!-- Power-ups Collection -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #FFD700; font-size: 16px; margin-bottom: 10px;">‚ö° Power-up Inventory</h3>
                    <div id="powerupCollection" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <!-- Power-up counts will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Streak Modal -->
        <div id="streakModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 3000;">
            <div style="background: linear-gradient(135deg, #FF6B35, #F7931E); border-radius: 20px; padding: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: white; margin: 0;">üî• Daily Streak</h2>
                    <button id="closeStreakBtn" style="background: #FF0000; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- Streak Stats -->
                <div style="background: rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üî•</div>
                    <div style="color: white; font-size: 24px; font-weight: bold;" id="currentStreak">0</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 14px;">Day Streak</div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-around;">
                        <div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 12px;">Longest</div>
                            <div style="color: white; font-weight: bold;" id="longestStreak">0</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 12px;">Total Logins</div>
                            <div style="color: white; font-weight: bold;" id="totalLogins">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Daily Gifts -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: white; font-size: 16px; margin-bottom: 10px;">üìÖ Daily Gifts</h3>
                    <div id="dailyGifts" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        <!-- Daily gift items will be added here -->
                    </div>
                </div>
                
                <!-- Streak Rewards -->
                <div>
                    <h3 style="color: white; font-size: 16px; margin-bottom: 10px;">üèÜ Streak Milestones</h3>
                    <div id="streakRewards" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Streak reward milestones will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Season Pass Modal -->
        <div id="seasonModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 3000;">
            <div style="background: linear-gradient(135deg, #667EEA, #764BA2); border-radius: 20px; padding: 20px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: white; margin: 0;">üèÜ Season Pass</h2>
                    <button id="closeSeasonBtn" style="background: #FF0000; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- Season Info -->
                <div style="background: rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="color: white; font-size: 18px; font-weight: bold;" id="seasonName">Gold Rush Season</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;" id="seasonDesc">Unlock rare skins and rewards</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: rgba(255,255,255,0.7); font-size: 12px;">Ends in</div>
                            <div style="color: white; font-weight: bold;" id="seasonTimer">14 days</div>
                        </div>
                    </div>
                    
                    <!-- Season Progress Bar -->
                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 30px; position: relative; overflow: hidden;">
                        <div id="seasonProgress" style="height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 0%; transition: width 1s ease;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 14px;">
                            Tier <span id="currentTier">1</span> / <span id="totalTiers">50</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: rgba(255,255,255,0.8); font-size: 12px;">
                            <span id="seasonExp">0</span> / <span id="seasonExpNext">100</span> XP
                        </div>
                        <button id="upgradePremiumBtn" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #333; border: none; padding: 5px 15px; border-radius: 10px; font-weight: bold; cursor: pointer;">üåü Upgrade to Premium</button>
                    </div>
                </div>
                
                <!-- Season Tiers -->
                <div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button id="freeRewardsBtn" class="season-tab active" style="flex: 1; background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer;">Free Rewards</button>
                        <button id="premiumRewardsBtn" class="season-tab" style="flex: 1; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); border: none; padding: 10px; border-radius: 10px; cursor: pointer;">Premium Rewards üîí</button>
                    </div>
                    <div id="seasonTiers" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">
                        <!-- Season tier rewards will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Coin Purchase Modal -->
        <div id="coinPurchaseModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 4000;">
            <div style="background: linear-gradient(135deg, #1a1a2e, #0f0f1e); border-radius: 20px; padding: 25px; max-width: 400px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #FFD700; margin: 0;">üí∞ Buy Coins</h2>
                    <button id="closeCoinPurchaseBtn" style="background: #FF0000; color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï</button>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Coin Packages -->
                    <div class="coin-package" onclick="purchaseCoins(500, 0.99)" style="background: rgba(255,255,255,0.1); border: 2px solid #FFD700; border-radius: 15px; padding: 15px; cursor: pointer; transition: transform 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #FFD700; font-size: 18px; font-weight: bold;">500 Coins</div>
                                <div style="color: #999; font-size: 12px;">Starter Pack</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #00C851, #00FF00); color: #333; padding: 8px 15px; border-radius: 10px; font-weight: bold;">$0.99</div>
                        </div>
                    </div>
                    
                    <div class="coin-package" onclick="purchaseCoins(2500, 4.99)" style="background: rgba(255,255,255,0.1); border: 2px solid #FFD700; border-radius: 15px; padding: 15px; cursor: pointer; transition: transform 0.2s; position: relative;">
                        <div style="position: absolute; top: -10px; right: 10px; background: #FF0000; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px;">POPULAR</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #FFD700; font-size: 18px; font-weight: bold;">2,500 Coins</div>
                                <div style="color: #999; font-size: 12px;">Best Value!</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #00C851, #00FF00); color: #333; padding: 8px 15px; border-radius: 10px; font-weight: bold;">$4.99</div>
                        </div>
                    </div>
                    
                    <div class="coin-package" onclick="purchaseCoins(5000, 9.99)" style="background: rgba(255,255,255,0.1); border: 2px solid #FFD700; border-radius: 15px; padding: 15px; cursor: pointer; transition: transform 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #FFD700; font-size: 18px; font-weight: bold;">5,000 Coins</div>
                                <div style="color: #999; font-size: 12px;">Pro Pack</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #00C851, #00FF00); color: #333; padding: 8px 15px; border-radius: 10px; font-weight: bold;">$9.99</div>
                        </div>
                    </div>
                    
                    <div class="coin-package" onclick="purchaseCoins(15000, 24.99)" style="background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(231,76,60,0.2)); border: 2px solid #9B59B6; border-radius: 15px; padding: 15px; cursor: pointer; transition: transform 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #FFD700; font-size: 18px; font-weight: bold;">15,000 Coins</div>
                                <div style="color: #E74C3C; font-size: 12px;">üî• Mega Pack + Bonus!</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #9B59B6, #E74C3C); color: white; padding: 8px 15px; border-radius: 10px; font-weight: bold;">$24.99</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                    <div style="color: #666; font-size: 11px; text-align: center; margin-bottom: 10px;">
                        üîí Secure payment powered by Stripe
                    </div>
                    <div style="color: #666; font-size: 10px; text-align: center;">
                        Note: This is a demo. No real charges will be made.
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Modal -->
        <div id="statsModal">
            <div class="stats-content">
                <h2 style="color: #FFD700; text-align: center; margin-bottom: 20px;">üìä Statistics</h2>
                <div class="stat-row">
                    <span class="stat-label">Games Played:</span>
                    <span id="statGames">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Score:</span>
                    <span id="statScore">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Coins:</span>
                    <span id="statCoins">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Combo:</span>
                    <span id="statCombo">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Achievements:</span>
                    <span id="statAchievements">0/12</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Play Time:</span>
                    <span id="statTime">0m</span>
                </div>
                <button id="closeStatsBtn" style="width: 100%; margin-top: 20px; background: #FFD700; color: #1a1a2e; border: none; padding: 12px; border-radius: 10px; font-weight: bold;">Close</button>
            </div>
        </div>

        <!-- Pause Menu -->
        <div id="pauseMenu" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; padding: 30px; text-align: center;">
                <h2 style="color: #FFD700; margin-bottom: 20px;">‚è∏Ô∏è PAUSED</h2>
                <button class="menu-button" id="resumeBtn" style="width: 200px; margin: 10px; background: #FFD700; color: #1a1a2e; padding: 12px; border-radius: 10px;">Resume</button>
                <button class="menu-button" id="restartBtn" style="width: 200px; margin: 10px; background: #FFD700; color: #1a1a2e; padding: 12px; border-radius: 10px;">Restart</button>
                <button class="menu-button" id="mainMenuBtn" style="width: 200px; margin: 10px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px; border-radius: 10px;">Main Menu</button>
            </div>
        </div>

        <!-- Game Over -->
        <div id="gameOver" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 4000;">
            <div style="background: linear-gradient(135deg, #DC143C, #8B0000); border-radius: 20px; padding: 30px; text-align: center; max-width: 400px;">
                <h2 style="color: #FFD700; margin-bottom: 20px;">üíÄ GAME OVER</h2>
                <div style="color: white; margin: 20px 0;">
                    <div>Score: <span id="finalScore">0</span></div>
                    <div>Coins: <span id="finalCoins">0</span></div>
                    <div>Level: <span id="finalLevel">1</span></div>
                    <div>Best Combo: <span id="finalCombo">0</span></div>
                </div>
                <button id="playAgainBtn" style="background: #FFD700; color: #1a1a2e; border: none; padding: 12px 30px; border-radius: 10px; margin: 5px; font-weight: bold;">Play Again</button>
                <button id="mainMenuBtn2" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 30px; border-radius: 10px; margin: 5px;">Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Prevent default touch behaviors
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Daily Streak System
        const DailyStreakManager = {
            streak: {
                current: 0,
                longest: 0,
                lastLogin: null,
                totalLogins: 0,
                gifts: [],
                milestones: [
                    { days: 7, rewards: { coins: 100, skin: 'streak_7_exclusive' }, claimed: false },
                    { days: 14, rewards: { coins: 250, gems: 50, skin: 'streak_14_exclusive' }, claimed: false },
                    { days: 30, rewards: { coins: 500, gems: 100, skin: 'streak_30_legendary' }, claimed: false }
                ]
            },
            
            init() {
                const saved = localStorage.getItem('dailyStreak');
                if (saved) {
                    this.streak = JSON.parse(saved);
                }
                this.generateDailyGifts();
                this.checkDailyLogin();
            },
            
            generateDailyGifts() {
                if (this.streak.gifts.length === 0) {
                    for (let day = 1; day <= 30; day++) {
                        const gift = {
                            day,
                            type: day % 7 === 0 ? 'skin' : day % 3 === 0 ? 'powerup' : day % 2 === 0 ? 'gems' : 'coins',
                            amount: day % 7 === 0 ? 1 : day % 3 === 0 ? 1 : day % 2 === 0 ? Math.floor(5 + day * 0.5) : Math.floor(10 + day * 2),
                            claimed: false,
                            available: false
                        };
                        this.streak.gifts.push(gift);
                    }
                }
            },
            
            checkDailyLogin() {
                const today = new Date().toDateString();
                const lastLogin = this.streak.lastLogin;
                
                if (lastLogin !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (lastLogin === yesterday.toDateString()) {
                        this.streak.current++;
                    } else {
                        this.streak.current = 1;
                    }
                    
                    this.streak.lastLogin = today;
                    this.streak.totalLogins++;
                    this.streak.longest = Math.max(this.streak.longest, this.streak.current);
                    
                    // Update available gifts
                    this.streak.gifts.forEach(gift => {
                        gift.available = gift.day <= this.streak.current && !gift.claimed;
                    });
                    
                    this.save();
                    this.showStreakNotification();
                }
            },
            
            claimGift(day) {
                const gift = this.streak.gifts.find(g => g.day === day);
                if (gift && gift.available && !gift.claimed) {
                    gift.claimed = true;
                    
                    // Apply rewards
                    if (gift.type === 'coins') {
                        game.coins += gift.amount;
                    } else if (gift.type === 'gems') {
                        game.gems = (game.gems || 0) + gift.amount;
                    }
                    
                    this.save();
                    return gift;
                }
                return null;
            },
            
            showStreakNotification() {
                if (this.streak.current > 1) {
                    showAchievement(`üî• ${this.streak.current} Day Streak!`, `Keep it up! Daily gifts available.`);
                    document.getElementById('streakBadge').style.display = 'inline';
                }
            },
            
            save() {
                localStorage.setItem('dailyStreak', JSON.stringify(this.streak));
            }
        };

        // Season Pass System
        const SeasonPassManager = {
            season: {
                id: 'season_1',
                name: 'Gold Rush Season',
                description: 'Unlock rare pot skins and exclusive rewards',
                startDate: new Date(),
                endDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),
                currentTier: 1,
                experience: 0,
                experienceToNext: 100,
                premium: false,
                tiers: []
            },
            
            init() {
                const saved = localStorage.getItem('seasonPass');
                if (saved) {
                    this.season = JSON.parse(saved);
                    this.season.startDate = new Date(this.season.startDate);
                    this.season.endDate = new Date(this.season.endDate);
                }
                
                if (this.season.tiers.length === 0) {
                    this.generateTiers();
                }
                
                this.checkSeasonEnd();
            },
            
            generateTiers() {
                for (let level = 1; level <= 50; level++) {
                    const tier = {
                        level,
                        experienceRequired: level * 100,
                        freeRewards: [
                            { type: 'coins', amount: 10 + level * 2 }
                        ],
                        premiumRewards: [
                            { type: 'coins', amount: 25 + level * 5 }
                        ],
                        unlocked: false,
                        claimed: false
                    };
                    
                    // Add special rewards at milestones
                    if (level % 5 === 0) {
                        tier.freeRewards.push({ type: 'powerup', amount: 1 });
                    }
                    if (level % 10 === 0) {
                        tier.freeRewards.push({ type: 'gems', amount: 5 });
                        tier.premiumRewards.push({ type: 'skin', itemId: `season_skin_${level}` });
                    }
                    
                    this.season.tiers.push(tier);
                }
            },
            
            addExperience(amount) {
                this.season.experience += amount;
                
                // Check for tier unlocks
                while (this.season.experience >= this.season.experienceToNext && this.season.currentTier < 50) {
                    const tier = this.season.tiers[this.season.currentTier - 1];
                    if (!tier.unlocked) {
                        tier.unlocked = true;
                        this.showTierUnlock(this.season.currentTier);
                    }
                    
                    this.season.currentTier++;
                    this.season.experienceToNext = this.season.currentTier * 100;
                }
                
                this.save();
                this.updateUI();
            },
            
            claimTierRewards(tierLevel) {
                const tier = this.season.tiers[tierLevel - 1];
                if (tier && tier.unlocked && !tier.claimed) {
                    tier.claimed = true;
                    
                    // Apply free rewards
                    tier.freeRewards.forEach(reward => {
                        if (reward.type === 'coins') {
                            game.coins += reward.amount;
                        } else if (reward.type === 'gems') {
                            game.gems = (game.gems || 0) + reward.amount;
                        }
                    });
                    
                    // Apply premium rewards if premium
                    if (this.season.premium) {
                        tier.premiumRewards.forEach(reward => {
                            if (reward.type === 'coins') {
                                game.coins += reward.amount;
                            } else if (reward.type === 'gems') {
                                game.gems = (game.gems || 0) + reward.amount;
                            } else if (reward.type === 'skin' && reward.itemId) {
                                if (!game.ownedSkins) game.ownedSkins = [];
                                game.ownedSkins.push(reward.itemId);
                            }
                        });
                    }
                    
                    this.save();
                    saveGameData();
                    return tier;
                }
                return null;
            },
            
            upgradeToPremium() {
                this.season.premium = true;
                this.save();
                document.getElementById('seasonBadge').style.display = 'inline';
                showAchievement('üåü Season Pass Premium!', 'Unlock exclusive rewards!');
            },
            
            checkSeasonEnd() {
                if (new Date() > this.season.endDate) {
                    // Start new season
                    this.season = {
                        id: `season_${parseInt(this.season.id.split('_')[1]) + 1}`,
                        name: 'New Season',
                        description: 'New challenges await!',
                        startDate: new Date(),
                        endDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),
                        currentTier: 1,
                        experience: 0,
                        experienceToNext: 100,
                        premium: false,
                        tiers: []
                    };
                    this.generateTiers();
                    this.save();
                }
            },
            
            showTierUnlock(tier) {
                showAchievement(`üéâ Tier ${tier} Unlocked!`, 'New rewards available!');
                document.getElementById('seasonBadge').style.display = 'inline';
            },
            
            updateUI() {
                const progress = (this.season.experience / this.season.experienceToNext) * 100;
                const progressBar = document.getElementById('seasonProgress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            },
            
            save() {
                localStorage.setItem('seasonPass', JSON.stringify(this.season));
            }
        };

        // Game State
        const game = {
            coins: 0,
            score: 0,
            level: 1,
            lives: 3,
            combo: 0,
            maxCombo: 0,
            isPaused: false,
            isGameOver: false,
            isPro: false,
            cartPosition: 0,
            cartSpeed: 4,
            currentSkin: 'üçØ',
            fallingItems: [],
            missedItems: [],
            blockageLevel: 0,
            powerups: {
                shield: 0,
                magnet: 0,
                double: 0
            },
            stats: {
                gamesPlayed: 0,
                totalScore: 0,
                totalCoins: 0,
                bestCombo: 0,
                achievements: [],
                playTime: 0
            },
            dailyChallenge: {
                type: 'coins',
                target: 100,
                progress: 0
            },
            isFirstTime: true
        };

        // Achievements
        const achievements = [
            { id: 'first_coin', name: 'First Steps', requirement: 'Collect your first coin', check: () => game.coins >= 1 },
            { id: 'combo_5', name: 'Combo Starter', requirement: 'Get a 5x combo', check: () => game.combo >= 5 },
            { id: 'combo_10', name: 'Combo Master', requirement: 'Get a 10x combo', check: () => game.combo >= 10 },
            { id: 'level_5', name: 'Level 5', requirement: 'Reach level 5', check: () => game.level >= 5 },
            { id: 'coins_100', name: 'Treasure Hunter', requirement: 'Collect 100 coins in one game', check: () => game.coins >= 100 },
            { id: 'no_damage', name: 'Untouchable', requirement: 'Reach level 3 without damage', check: () => game.level >= 3 && game.lives === 3 }
        ];

        // Pro User System
        const ProManager = {
            checkProStatus: () => {
                const proData = localStorage.getItem('proUser');
                if (proData) {
                    const { expiry } = JSON.parse(proData);
                    return new Date() < new Date(expiry);
                }
                return false;
            },
            
            activatePro: (days = 30) => {
                const expiry = new Date();
                expiry.setDate(expiry.getDate() + days);
                localStorage.setItem('proUser', JSON.stringify({
                    activated: new Date(),
                    expiry: expiry,
                    userId: 'user_' + Date.now()
                }));
                game.isPro = true;
                showAchievement({ name: 'Gold Vault Activated! üèÜ' });
            },
            
            getProBenefits: () => {
                if (ProManager.checkProStatus()) {
                    return {
                        coinMultiplier: 2,
                        exclusiveDrops: true,
                        noAds: true,
                        dailyBonus: 500,
                        specialSkins: ['gold_cart', 'diamond_cart', 'mystery_crate']
                    };
                }
                return null;
            },
            
            claimDailyBonus: () => {
                const lastClaim = localStorage.getItem('lastDailyBonus');
                const today = new Date().toDateString();
                
                if (!lastClaim || lastClaim !== today) {
                    if (ProManager.checkProStatus()) {
                        game.coins += 500;
                        localStorage.setItem('lastDailyBonus', today);
                        showAchievement({ name: 'Daily Bonus: +500 coins! üí∞' });
                        updateUI();
                        return true;
                    }
                }
                return false;
            }
        };

        // Loading tips
        const loadingTips = [
            'Tip: Collect combos for bonus points!',
            'Tip: Use power-ups to clear blocked paths!',
            'Tip: Avoid bombs to keep your lives!',
            'Tip: Complete daily challenges for rewards!',
            'Tip: Higher levels mean faster falling items!'
        ];

        // Shop items
        const shopItems = [
            // Basic Carts
            { id: 'pot_classic', name: 'Classic Pot', icon: 'üçØ', price: 0, owned: true, rarity: 'common' },
            { id: 'cart_wooden', name: 'Wooden Cart', icon: 'üõí', price: 100, owned: false, rarity: 'common' },
            { id: 'cart_gold', name: 'Golden Cart', icon: 'üèÜ', price: 500, owned: false, rarity: 'rare' },
            { id: 'cart_diamond', name: 'Diamond Cart', icon: 'üíé', price: 1000, owned: false, rarity: 'epic' },
            { id: 'cart_mystery', name: 'Mystery Crate', icon: 'üì¶', price: 1500, owned: false, rarity: 'legendary' },
            
            // All 50 State Flag Carts
            { id: 'cart_alabama', name: 'Alabama Cart', icon: 'üåæ', price: 500, owned: false, rarity: 'rare', state: 'AL' },
            { id: 'cart_alaska', name: 'Alaska Cart', icon: 'üêª', price: 500, owned: false, rarity: 'rare', state: 'AK' },
            { id: 'cart_arizona', name: 'Arizona Cart', icon: 'üåµ', price: 500, owned: false, rarity: 'rare', state: 'AZ' },
            { id: 'cart_arkansas', name: 'Arkansas Cart', icon: 'üíé', price: 500, owned: false, rarity: 'rare', state: 'AR' },
            { id: 'cart_california', name: 'California Cart', icon: 'üå¥', price: 750, owned: false, rarity: 'epic', state: 'CA' },
            { id: 'cart_colorado', name: 'Colorado Cart', icon: '‚õ∞Ô∏è', price: 500, owned: false, rarity: 'rare', state: 'CO' },
            { id: 'cart_connecticut', name: 'Connecticut Cart', icon: 'üçÇ', price: 500, owned: false, rarity: 'rare', state: 'CT' },
            { id: 'cart_delaware', name: 'Delaware Cart', icon: 'üèñÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'DE' },
            { id: 'cart_florida', name: 'Florida Cart', icon: 'üå∫', price: 750, owned: false, rarity: 'epic', state: 'FL' },
            { id: 'cart_georgia', name: 'Georgia Cart', icon: 'üçë', price: 500, owned: false, rarity: 'rare', state: 'GA' },
            { id: 'cart_hawaii', name: 'Hawaii Cart', icon: 'üå∫', price: 750, owned: false, rarity: 'epic', state: 'HI' },
            { id: 'cart_idaho', name: 'Idaho Cart', icon: 'ü•î', price: 500, owned: false, rarity: 'rare', state: 'ID' },
            { id: 'cart_illinois', name: 'Illinois Cart', icon: 'üåÜ', price: 500, owned: false, rarity: 'rare', state: 'IL' },
            { id: 'cart_indiana', name: 'Indiana Cart', icon: 'üèÅ', price: 500, owned: false, rarity: 'rare', state: 'IN' },
            { id: 'cart_iowa', name: 'Iowa Cart', icon: 'üåΩ', price: 500, owned: false, rarity: 'rare', state: 'IA' },
            { id: 'cart_kansas', name: 'Kansas Cart', icon: 'üåª', price: 500, owned: false, rarity: 'rare', state: 'KS' },
            { id: 'cart_kentucky', name: 'Kentucky Cart', icon: 'üèá', price: 500, owned: false, rarity: 'rare', state: 'KY' },
            { id: 'cart_louisiana', name: 'Louisiana Cart', icon: 'üé∫', price: 500, owned: false, rarity: 'rare', state: 'LA' },
            { id: 'cart_maine', name: 'Maine Cart', icon: 'ü¶û', price: 500, owned: false, rarity: 'rare', state: 'ME' },
            { id: 'cart_maryland', name: 'Maryland Cart', icon: 'ü¶Ä', price: 500, owned: false, rarity: 'rare', state: 'MD' },
            { id: 'cart_massachusetts', name: 'Massachusetts Cart', icon: 'üìö', price: 500, owned: false, rarity: 'rare', state: 'MA' },
            { id: 'cart_michigan', name: 'Michigan Cart', icon: 'üöó', price: 500, owned: false, rarity: 'rare', state: 'MI' },
            { id: 'cart_minnesota', name: 'Minnesota Cart', icon: '‚ùÑÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'MN' },
            { id: 'cart_mississippi', name: 'Mississippi Cart', icon: 'üéµ', price: 500, owned: false, rarity: 'rare', state: 'MS' },
            { id: 'cart_missouri', name: 'Missouri Cart', icon: 'üèõÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'MO' },
            { id: 'cart_montana', name: 'Montana Cart', icon: 'ü¶å', price: 500, owned: false, rarity: 'rare', state: 'MT' },
            { id: 'cart_nebraska', name: 'Nebraska Cart', icon: 'üåæ', price: 500, owned: false, rarity: 'rare', state: 'NE' },
            { id: 'cart_nevada', name: 'Nevada Cart', icon: 'üé∞', price: 750, owned: false, rarity: 'epic', state: 'NV' },
            { id: 'cart_newhampshire', name: 'New Hampshire Cart', icon: 'üèîÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'NH' },
            { id: 'cart_newjersey', name: 'New Jersey Cart', icon: 'üèñÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'NJ' },
            { id: 'cart_newmexico', name: 'New Mexico Cart', icon: 'üå∂Ô∏è', price: 500, owned: false, rarity: 'rare', state: 'NM' },
            { id: 'cart_newyork', name: 'New York Cart', icon: 'üóΩ', price: 750, owned: false, rarity: 'epic', state: 'NY' },
            { id: 'cart_northcarolina', name: 'North Carolina Cart', icon: '‚úàÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'NC' },
            { id: 'cart_northdakota', name: 'North Dakota Cart', icon: 'ü¶¨', price: 500, owned: false, rarity: 'rare', state: 'ND' },
            { id: 'cart_ohio', name: 'Ohio Cart', icon: 'üé∏', price: 500, owned: false, rarity: 'rare', state: 'OH' },
            { id: 'cart_oklahoma', name: 'Oklahoma Cart', icon: 'üå™Ô∏è', price: 500, owned: false, rarity: 'rare', state: 'OK' },
            { id: 'cart_oregon', name: 'Oregon Cart', icon: 'üå≤', price: 500, owned: false, rarity: 'rare', state: 'OR' },
            { id: 'cart_pennsylvania', name: 'Pennsylvania Cart', icon: 'üîî', price: 500, owned: false, rarity: 'rare', state: 'PA' },
            { id: 'cart_rhodeisland', name: 'Rhode Island Cart', icon: '‚öì', price: 500, owned: false, rarity: 'rare', state: 'RI' },
            { id: 'cart_southcarolina', name: 'South Carolina Cart', icon: 'üå¥', price: 500, owned: false, rarity: 'rare', state: 'SC' },
            { id: 'cart_southdakota', name: 'South Dakota Cart', icon: 'üóø', price: 500, owned: false, rarity: 'rare', state: 'SD' },
            { id: 'cart_tennessee', name: 'Tennessee Cart', icon: 'üé∏', price: 500, owned: false, rarity: 'rare', state: 'TN' },
            { id: 'cart_texas', name: 'Texas Cart', icon: 'ü§†', price: 750, owned: false, rarity: 'epic', state: 'TX' },
            { id: 'cart_utah', name: 'Utah Cart', icon: 'üèîÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'UT' },
            { id: 'cart_vermont', name: 'Vermont Cart', icon: 'üçÅ', price: 500, owned: false, rarity: 'rare', state: 'VT' },
            { id: 'cart_virginia', name: 'Virginia Cart', icon: 'üèõÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'VA' },
            { id: 'cart_washington', name: 'Washington Cart', icon: '‚òï', price: 500, owned: false, rarity: 'rare', state: 'WA' },
            { id: 'cart_westvirginia', name: 'West Virginia Cart', icon: '‚õèÔ∏è', price: 500, owned: false, rarity: 'rare', state: 'WV' },
            { id: 'cart_wisconsin', name: 'Wisconsin Cart', icon: 'üßÄ', price: 500, owned: false, rarity: 'rare', state: 'WI' },
            { id: 'cart_wyoming', name: 'Wyoming Cart', icon: 'ü¶å', price: 500, owned: false, rarity: 'rare', state: 'WY' },
            
            // Special Edition Carts
            { id: 'cart_blackhistory', name: 'Black History Cart', icon: '‚úä', price: 1000, owned: false, rarity: 'legendary', special: true },
            { id: 'cart_hispanic', name: 'Hispanic Heritage', icon: 'üéâ', price: 1000, owned: false, rarity: 'seasonal', special: true },
            { id: 'cart_holiday', name: 'Holiday Star', icon: '‚≠ê', price: 1200, owned: false, rarity: 'seasonal', special: true },
            { id: 'cart_ghost', name: 'Ghost Trail', icon: 'üëª', price: 800, owned: false, rarity: 'rare', special: true },
            
            // Power-ups
            { id: 'powerup_shield', name: 'Shield Pack (3x)', icon: 'üõ°Ô∏è', price: 100, type: 'powerup' },
            { id: 'powerup_magnet', name: 'Magnet Pack (3x)', icon: 'üß≤', price: 150, type: 'powerup' },
            { id: 'powerup_double', name: 'Double Coins (3x)', icon: 'x2', price: 200, type: 'powerup' },
            { id: 'powerup_vacuum', name: 'Vacuum Pack (3x)', icon: 'üå™Ô∏è', price: 250, type: 'powerup' },
            
            // Special Items
            { id: 'sparkle_peach', name: 'Peach Sparkle', icon: 'üçë', price: 300, type: 'effect', rarity: 'rare' },
            { id: 'sparkle_gold', name: 'Gold Sparkle', icon: '‚ú®', price: 400, type: 'effect', rarity: 'rare' },
            { id: 'unlock_holiday', name: 'Holiday Unlock', icon: 'üéÖ', price: 2000, type: 'unlock', rarity: 'legendary' }
        ];

        // Initialize
        function init() {
            loadGameData();
            setupTouchControls();
            initCartPosition();
            
            // Initialize systems
            DailyStreakManager.init();
            SeasonPassManager.init();
            
            // Check pro status
            game.isPro = ProManager.checkProStatus();
            if (game.isPro) {
                // Claim daily bonus if available
                ProManager.claimDailyBonus();
                // Show pro badge
                document.getElementById('proBadge').style.display = 'inline-block';
            }
            
            // Load saved skin
            const savedSkin = localStorage.getItem('currentSkin');
            if (savedSkin) {
                try {
                    const skin = JSON.parse(savedSkin);
                    applyCartSkin(skin);
                } catch (e) {
                    // Default skin if parse fails
                    document.getElementById('cart').textContent = 'üçØ';
                }
            }
            
            // Show random loading tip
            document.getElementById('loadingTip').textContent = loadingTips[Math.floor(Math.random() * loadingTips.length)];
            
            // Show tutorial for first time players
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainMenu').classList.remove('hidden');
                
                if (game.isFirstTime) {
                    showTutorial();
                    game.isFirstTime = false;
                    saveGameData();
                }
            }, 1500);
            
            setupEventListeners();
            updateDailyChallenge();
        }

        // Initialize cart position
        function initCartPosition() {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            game.cartPosition = rect.width / 2;
            const cart = document.getElementById('cart');
            cart.style.left = (game.cartPosition - 30) + 'px';
        }

        // Setup touch controls - FIXED FOR MOBILE
        function setupTouchControls() {
            const leftTouch = document.getElementById('leftTouch');
            const rightTouch = document.getElementById('rightTouch');
            const centerTouch = document.getElementById('centerTouch');
            
            // Touch event handlers
            function handleTouchStart(e, direction) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!game.isPaused && !game.isGameOver) {
                    moveCart(direction);
                    
                    // Show touch feedback
                    const touch = e.touches[0];
                    showTouchFeedback(touch.clientX, touch.clientY);
                }
            }
            
            // Left touch area
            leftTouch.addEventListener('touchstart', (e) => handleTouchStart(e, -1), { passive: false });
            leftTouch.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (!game.isPaused && !game.isGameOver) moveCart(-1);
            });
            
            // Right touch area
            rightTouch.addEventListener('touchstart', (e) => handleTouchStart(e, 1), { passive: false });
            rightTouch.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (!game.isPaused && !game.isGameOver) moveCart(1);
            });
            
            // Center touch area (optional - for special action)
            centerTouch.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Could trigger a special action here
            }, { passive: false });
        }

        // Show touch feedback
        function showTouchFeedback(x, y) {
            const indicator = document.getElementById('touchIndicator');
            indicator.style.left = (x - 30) + 'px';
            indicator.style.top = (y - 30) + 'px';
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 300);
        }

        // Move cart
        function moveCart(direction) {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const cart = document.getElementById('cart');
            const cartWidth = 60;
            
            const newPosition = game.cartPosition + (direction * 30); // Fixed step movement
            
            if (newPosition >= cartWidth/2 && newPosition <= rect.width - cartWidth/2) {
                game.cartPosition = newPosition;
                cart.style.left = (newPosition - cartWidth/2) + 'px';
            }
        }

        // Show tutorial
        function showTutorial() {
            document.getElementById('tutorialOverlay').classList.add('active');
        }

        // Update daily challenge
        function updateDailyChallenge() {
            const challenges = [
                { type: 'coins', target: 100, text: 'Collect 100 coins' },
                { type: 'combo', target: 10, text: 'Get a 10x combo' },
                { type: 'level', target: 5, text: 'Reach level 5' },
                { type: 'nodamage', target: 1, text: 'Complete without damage' }
            ];
            
            // Rotate daily challenge based on date
            const today = new Date().getDay();
            game.dailyChallenge = challenges[today % challenges.length];
            
            document.getElementById('dailyChallengeText').textContent = game.dailyChallenge.text;
            updateDailyChallengeProgress();
        }

        // Update daily challenge progress
        function updateDailyChallengeProgress() {
            const progress = (game.dailyChallenge.progress / game.dailyChallenge.target) * 100;
            document.getElementById('dailyProgress').style.width = Math.min(progress, 100) + '%';
        }

        // Start game
        function startGame() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('active');
            
            resetGame();
            game.isPaused = false;
            game.isGameOver = false;
            game.stats.gamesPlayed++;
            
            gameLoop();
            spawnItems();
            
            // Update powerup display
            updatePowerupInventory();
        }

        // Reset game
        function resetGame() {
            game.fallingItems.forEach(obj => obj.element && obj.element.remove());
            game.missedItems.forEach(obj => obj.element && obj.element.remove());
            
            game.coins = 0;
            game.score = 0;
            game.level = 1;
            game.lives = 3;
            game.combo = 0;
            game.maxCombo = 0;
            game.fallingItems = [];
            game.missedItems = [];
            game.blockageLevel = 0;
            
            initCartPosition();
            updateUI();
        }

        // Game loop
        function gameLoop() {
            if (game.isPaused || game.isGameOver) return;

            updateFallingItems();
            checkCollisions();
            updateBlockage();
            checkAchievements();
            checkGameOver();
            updateUI();

            requestAnimationFrame(gameLoop);
        }

        // Spawn items
        let spawnTimeout = null;
        function spawnItems() {
            if (game.isPaused || game.isGameOver) {
                clearTimeout(spawnTimeout);
                return;
            }

            const spawnRate = Math.max(500, 2000 - (game.level * 100));
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            
            let itemTypes = [
                // Regular drops
                { type: 'coin', emoji: 'ü™ô', value: 1, points: 10, harmful: false, probability: 0.3 },
                { type: 'gold', emoji: 'üí∞', value: 5, points: 50, harmful: false, probability: 0.12 },
                { type: 'gem', emoji: 'üíé', value: 10, points: 100, harmful: false, probability: 0.08 },
                { type: 'star', emoji: '‚≠ê', value: 3, points: 30, harmful: false, probability: 0.15 },
                { type: 'clover', emoji: 'üçÄ', value: 7, points: 70, harmful: false, probability: 0.08 },
                { type: 'horseshoe', emoji: 'üß≤', value: 4, points: 40, harmful: false, probability: 0.08 },
                { type: 'bomb', emoji: 'üí£', value: 0, points: 0, harmful: true, probability: 0.12 },
                { type: 'powerup', emoji: 'üéÅ', value: 0, points: 20, harmful: false, probability: 0.03 }
            ];
            
            // Add pro-only drops if user is pro
            if (game.isPro) {
                itemTypes.push(
                    { type: 'gem_purple', emoji: 'üíú', value: 15, points: 150, harmful: false, probability: 0.03, pro: true },
                    { type: 'coin_drop', emoji: 'üí∏', value: 50, points: 500, harmful: false, probability: 0.02, pro: true },
                    { type: 'rainbow', emoji: 'üåà', value: 25, points: 250, harmful: false, probability: 0.02, pro: true }
                );
            }
            
            const item = selectRandomItem(itemTypes);
            const x = Math.random() * (rect.width - 30);
            
            createFallingItem(item, x);

            clearTimeout(spawnTimeout);
            spawnTimeout = setTimeout(spawnItems, spawnRate);
        }

        // Select random item
        function selectRandomItem(items) {
            const rand = Math.random();
            let cumulative = 0;
            
            for (const item of items) {
                cumulative += item.probability;
                if (rand <= cumulative) {
                    return item;
                }
            }
            return items[0];
        }

        // Create falling item
        function createFallingItem(item, x) {
            const element = document.createElement('div');
            element.className = 'falling-item';
            element.style.left = x + 'px';
            element.style.top = '0px';
            element.textContent = item.emoji;
            
            const fallSpeed = 3 + (game.level * 0.3);
            element.style.animationDuration = (8 / fallSpeed) + 's';
            
            document.getElementById('gameCanvas').appendChild(element);
            
            game.fallingItems.push({
                element: element,
                x: x,
                y: 0,
                item: item
            });
        }

        // Update falling items
        function updateFallingItems() {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            
            game.fallingItems = game.fallingItems.filter(obj => {
                const itemRect = obj.element.getBoundingClientRect();
                const relativeY = itemRect.top - rect.top;
                
                // Check if item reached bottom (cart area)
                if (relativeY > rect.height - 60) {
                    // Item missed the cart
                    if (!obj.item.harmful && obj.item.type !== 'powerup') {
                        addMissedItem(obj.x, obj.item);
                        game.combo = 0;
                        updateComboDisplay();
                    }
                    obj.element.remove();
                    return false;
                }
                return true;
            });
        }

        // Add missed item
        function addMissedItem(x, item) {
            const canvas = document.getElementById('gameCanvas');
            const element = document.createElement('div');
            element.className = 'missed-item';
            element.style.left = x + 'px';
            // Fix: Position from top of canvas at the bottom
            const canvasHeight = canvas.getBoundingClientRect().height;
            element.style.top = (canvasHeight - 60 - (game.missedItems.length * 20)) + 'px';
            element.style.position = 'absolute';
            element.style.fontSize = '18px';
            element.style.opacity = '0.7';
            element.textContent = item.emoji;
            
            canvas.appendChild(element);
            game.missedItems.push({ element: element, x: x });
            
            updateBlockage();
        }

        // Update blockage with warning system
        function updateBlockage() {
            const BLOCKAGE_WARNING = 25;  // Show warning at 25 items
            const BLOCKAGE_CRITICAL = 35; // Critical warning at 35 items  
            const BLOCKAGE_MAX = 40;      // Game over at 40 items
            
            game.blockageLevel = Math.min(game.missedItems.length / BLOCKAGE_MAX, 1);
            
            // Show countdown warning
            if (game.missedItems.length >= BLOCKAGE_WARNING) {
                const remaining = BLOCKAGE_MAX - game.missedItems.length;
                const warningDiv = document.getElementById('blockageWarning');
                
                if (!warningDiv) {
                    const warning = document.createElement('div');
                    warning.id = 'blockageWarning';
                    warning.style.cssText = `
                        position: fixed;
                        top: 120px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: ${game.missedItems.length >= BLOCKAGE_CRITICAL ? 
                            'linear-gradient(135deg, #FF0000, #FF6B6B)' : 
                            'linear-gradient(135deg, #FFA500, #FFD700)'};
                        color: white;
                        padding: 10px 20px;
                        border-radius: 20px;
                        font-weight: bold;
                        font-size: 14px;
                        z-index: 1000;
                        animation: pulse 1s infinite;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    `;
                    warning.innerHTML = `‚ö†Ô∏è PATH BLOCKING: ${remaining} items until GAME OVER! Clear now!`;
                    document.getElementById('gameCanvas').appendChild(warning);
                } else {
                    warningDiv.innerHTML = `‚ö†Ô∏è PATH BLOCKING: ${remaining} items until GAME OVER! ${remaining <= 5 ? 'üö®' : ''}`;
                    warningDiv.style.background = game.missedItems.length >= BLOCKAGE_CRITICAL ? 
                        'linear-gradient(135deg, #FF0000, #FF6B6B)' : 
                        'linear-gradient(135deg, #FFA500, #FFD700)';
                }
                
                // Flash screen edges when critical
                if (game.missedItems.length >= BLOCKAGE_CRITICAL) {
                    document.getElementById('gameCanvas').style.boxShadow = '0 0 20px rgba(255,0,0,0.5)';
                }
            } else {
                // Remove warning if below threshold
                const warningDiv = document.getElementById('blockageWarning');
                if (warningDiv) warningDiv.remove();
                document.getElementById('gameCanvas').style.boxShadow = 'none';
            }
        }

        // Check collisions
        function checkCollisions() {
            const cart = document.getElementById('cart');
            const cartRect = cart.getBoundingClientRect();
            const canvas = document.getElementById('gameCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            game.fallingItems = game.fallingItems.filter((obj) => {
                const itemRect = obj.element.getBoundingClientRect();
                
                // Check if item is at cart level
                const itemBottom = itemRect.bottom - canvasRect.top;
                const cartTop = cartRect.top - canvasRect.top;
                
                if (itemBottom >= cartTop && itemBottom <= cartTop + 60 &&
                    itemRect.left < cartRect.right &&
                    itemRect.right > cartRect.left) {
                    
                    // Item caught by cart
                    handleItemCollection(obj);
                    obj.element.remove();
                    return false; // Remove from array
                }
                return true; // Keep in array
            });
        }

        // Handle item collection
        function handleItemCollection(obj) {
            const item = obj.item;
            
            if (item.harmful) {
                if (game.powerups.shield > 0) {
                    game.powerups.shield--;
                    updatePowerupInventory();
                } else {
                    game.lives--;
                    game.combo = 0;
                }
            } else {
                let multiplier = game.powerups.double > 0 ? 2 : 1;
                // Apply pro multiplier
                if (game.isPro) {
                    multiplier *= 2; // Pro users get 2x coins
                }
                game.coins += item.value * multiplier;
                game.score += item.points * (1 + game.combo * 0.1);
                
                // Add season pass experience
                SeasonPassManager.addExperience(Math.floor(item.points / 10));
                
                if (item.type === 'powerup') {
                    // Random powerup
                    const powerupType = ['shield', 'magnet', 'double'][Math.floor(Math.random() * 3)];
                    game.powerups[powerupType]++;
                    updatePowerupInventory();
                }
                
                game.combo++;
                game.maxCombo = Math.max(game.maxCombo, game.combo);
                
                // Show collection effect
                showCollectionEffect(obj.element.getBoundingClientRect().left, obj.element.getBoundingClientRect().top, '+' + item.points);
                
                updateComboDisplay();
                
                // Update daily challenge
                if (game.dailyChallenge.type === 'coins') {
                    game.dailyChallenge.progress += item.value;
                    updateDailyChallengeProgress();
                }
            }
            
            // Element removal handled in checkCollisions now
            
            // Check for level up
            if (game.score > game.level * 100) {
                game.level++;
            }
        }

        // Show collection effect
        function showCollectionEffect(x, y, text) {
            const effect = document.createElement('div');
            effect.className = 'collect-effect';
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            effect.textContent = text;
            
            document.getElementById('gameCanvas').appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }

        // Update combo display
        function updateComboDisplay() {
            const display = document.getElementById('comboDisplay');
            const text = document.getElementById('comboText');
            
            if (game.combo > 1) {
                text.textContent = `Combo x${game.combo}!`;
                display.classList.add('active');
            } else {
                display.classList.remove('active');
            }
        }

        // Update powerup inventory
        function updatePowerupInventory() {
            document.querySelector('#shieldSlot .powerup-slot-count').textContent = game.powerups.shield;
            document.querySelector('#magnetSlot .powerup-slot-count').textContent = game.powerups.magnet;
            document.querySelector('#doubleSlot .powerup-slot-count').textContent = game.powerups.double;
            
            const totalPowerups = game.powerups.shield + game.powerups.magnet + game.powerups.double;
            document.getElementById('powerupCount').textContent = totalPowerups;
            document.getElementById('powerupCount').style.display = totalPowerups > 0 ? 'flex' : 'none';
        }

        // Check achievements
        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!game.stats.achievements.includes(achievement.id) && achievement.check()) {
                    game.stats.achievements.push(achievement.id);
                    showAchievement(achievement);
                }
            });
        }

        // Show achievement
        function showAchievement(achievement) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementName').textContent = achievement.name;
            popup.classList.add('active');
            
            setTimeout(() => {
                popup.classList.remove('active');
            }, 3000);
        }

        // Check game over
        function checkGameOver() {
            if (game.lives <= 0 || game.blockageLevel >= 1.0) {
                gameOver();
            }
        }

        // Game over
        function gameOver() {
            game.isGameOver = true;
            
            // Update stats
            game.stats.totalScore += game.score;
            game.stats.totalCoins += game.coins;
            game.stats.bestCombo = Math.max(game.stats.bestCombo, game.maxCombo);
            
            saveGameData();
            
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('finalCoins').textContent = game.coins;
            document.getElementById('finalLevel').textContent = game.level;
            document.getElementById('finalCombo').textContent = game.maxCombo;
            document.getElementById('gameOver').style.display = 'flex';
        }

        // Update UI
        function updateUI() {
            document.getElementById('coins').textContent = game.coins;
            document.getElementById('score').textContent = game.score;
            document.getElementById('level').textContent = game.level;
            document.getElementById('lives').textContent = game.lives;
        }

        // Save game data
        function saveGameData() {
            localStorage.setItem('potOfGoldData', JSON.stringify({
                stats: game.stats,
                powerups: game.powerups,
                isFirstTime: game.isFirstTime
            }));
        }

        // Load game data
        function loadGameData() {
            const saved = localStorage.getItem('potOfGoldData');
            if (saved) {
                const data = JSON.parse(saved);
                game.stats = data.stats || game.stats;
                game.powerups = data.powerups || game.powerups;
                game.isFirstTime = data.isFirstTime !== undefined ? data.isFirstTime : true;
            }
            
            // Update displays
            document.getElementById('bestScore').textContent = Math.max(...(game.stats.achievements.map(() => game.stats.totalScore)), 0);
            document.getElementById('totalCoins').textContent = game.stats.totalCoins;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Menu
            document.getElementById('playBtn').onclick = startGame;
            document.getElementById('tutorialBtn').onclick = showTutorial;
            document.getElementById('closeTutorial').onclick = () => {
                document.getElementById('tutorialOverlay').classList.remove('active');
            };
            
            // Pro button
            document.getElementById('proBtn').onclick = () => {
                if (game.isPro) {
                    alert('You are already a Pro member! Enjoying 2x coins and exclusive drops.');
                } else {
                    if (confirm('Activate Pro Membership?\n\n‚ú® Benefits:\n‚Ä¢ 2x Coins on all collections\n‚Ä¢ Exclusive pro-only drops (üíú üí∏ üåà)\n‚Ä¢ Daily 500 coin bonus\n‚Ä¢ Ad-free experience\n\n(Demo: 30-day free trial)')) {
                        ProManager.activatePro(30);
                        game.isPro = true;
                        document.getElementById('proBadge').style.display = 'inline-block';
                        document.getElementById('proBtn').innerHTML = '‚≠ê Pro Member - Active';
                        document.getElementById('proBtn').style.background = 'linear-gradient(135deg, #00C851, #00FF00)';
                    }
                }
            };
            
            // Daily Streak button
            document.getElementById('streakBtn').onclick = () => {
                openStreakModal();
            };
            
            // Season Pass button  
            document.getElementById('seasonBtn').onclick = () => {
                openSeasonModal();
            };
            
            // Profile/Collection
            document.getElementById('profileBtn').onclick = () => {
                loadCollection();
                document.getElementById('profileModal').style.display = 'flex';
            };
            
            document.getElementById('closeProfileBtn').onclick = () => {
                document.getElementById('profileModal').style.display = 'none';
            };
            
            // Stats
            document.getElementById('statsBtn').onclick = () => {
                document.getElementById('statGames').textContent = game.stats.gamesPlayed;
                document.getElementById('statScore').textContent = game.stats.totalScore;
                document.getElementById('statCoins').textContent = game.stats.totalCoins;
                document.getElementById('statCombo').textContent = game.stats.bestCombo;
                document.getElementById('statAchievements').textContent = game.stats.achievements.length + '/6';
                document.getElementById('statTime').textContent = Math.floor(game.stats.playTime / 60) + 'm';
                document.getElementById('statsModal').classList.add('active');
            };
            
            document.getElementById('closeStatsBtn').onclick = () => {
                document.getElementById('statsModal').classList.remove('active');
            };
            
            // Game controls
            document.getElementById('pauseBtn').onclick = () => {
                game.isPaused = true;
                document.getElementById('pauseMenu').style.display = 'flex';
            };
            
            document.getElementById('resumeBtn').onclick = () => {
                game.isPaused = false;
                document.getElementById('pauseMenu').style.display = 'none';
                // Clear any stuck keyboard input
                if (window.keys) {
                    Object.keys(window.keys).forEach(key => {
                        window.keys[key] = false;
                    });
                }
                gameLoop();
                spawnItems(); // Restart the item spawning chain
            };
            
            document.getElementById('restartBtn').onclick = () => {
                document.getElementById('pauseMenu').style.display = 'none';
                resetGame();
                game.isPaused = false;
                game.isGameOver = false;
                gameLoop();
                spawnItems();
            };
            
            document.getElementById('mainMenuBtn').onclick = returnToMenu;
            document.getElementById('mainMenuBtn2').onclick = returnToMenu;
            
            function returnToMenu() {
                document.getElementById('gameContainer').classList.remove('active');
                document.getElementById('pauseMenu').style.display = 'none';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('mainMenu').classList.remove('hidden');
                resetGame();
            }
            
            // Power-ups with auto-pause
            document.getElementById('vacuumBtn').onclick = () => {
                const VACUUM_PRICE = 25; // Reduced from 50
                
                // Auto-pause during transaction
                const wasPlaying = !game.isPaused;
                game.isPaused = true;
                
                if (game.coins >= VACUUM_PRICE) {
                    if (confirm(`Use Vacuum Power?\nCost: ${VACUUM_PRICE} coins\n\nClears items in a 150px radius around your cart.`)) {
                        game.coins -= VACUUM_PRICE;
                        const cartX = game.cartPosition;
                        const range = 150;
                        
                        let itemsCleared = 0;
                        game.missedItems = game.missedItems.filter(item => {
                            if (Math.abs(item.x - cartX) <= range) {
                                item.element.remove();
                                game.coins += 1; // Refund 1 coin per item cleared
                                itemsCleared++;
                                return false;
                            }
                            return true;
                        });
                        
                        updateBlockage();
                        updateUI();
                        showAchievement({ name: `Vacuum used! Cleared ${itemsCleared} items!` });
                    }
                } else {
                    alert(`Not enough coins! Need ${VACUUM_PRICE} coins.\nYou have: ${game.coins} coins`);
                }
                
                // Resume if was playing
                if (wasPlaying) {
                    game.isPaused = false;
                    gameLoop();
                    spawnItems();
                }
            };
            
            document.getElementById('clearBtn').onclick = () => {
                const CLEAR_PRICE = 50; // Reduced from 100
                
                // Auto-pause during transaction
                const wasPlaying = !game.isPaused;
                game.isPaused = true;
                
                if (game.coins >= CLEAR_PRICE) {
                    const itemCount = game.missedItems.length;
                    if (itemCount === 0) {
                        alert('No items to clear!');
                    } else if (confirm(`Clear ALL blocked items?\nCost: ${CLEAR_PRICE} coins\n\n${itemCount} items will be cleared.`)) {
                        game.coins -= CLEAR_PRICE;
                        game.missedItems.forEach(item => item.element.remove());
                        game.missedItems = [];
                        game.blockageLevel = 0;
                        
                        // Remove warning
                        const warningDiv = document.getElementById('blockageWarning');
                        if (warningDiv) warningDiv.remove();
                        document.getElementById('gameCanvas').style.boxShadow = 'none';
                        
                        updateUI();
                        showAchievement({ name: `Path cleared! ${itemCount} items removed!` });
                    }
                } else {
                    alert(`Not enough coins! Need ${CLEAR_PRICE} coins.\nYou have: ${game.coins} coins`);
                }
                
                // Resume if was playing
                if (wasPlaying) {
                    game.isPaused = false;
                    gameLoop();
                    spawnItems();
                }
            };
            
            // Powerup slots
            document.getElementById('shieldSlot').onclick = () => {
                if (game.powerups.shield > 0) {
                    // Activate shield
                    game.powerups.shield--;
                    updatePowerupInventory();
                }
            };
            
            // Shop
            document.getElementById('shopBtn').onclick = () => {
                game.isPaused = true;
                loadShopItems();
                document.getElementById('shopCoins').textContent = game.coins;
                document.getElementById('shopModal').classList.add('active');
            };
            
            document.getElementById('closeShopBtn').onclick = () => {
                document.getElementById('shopModal').classList.remove('active');
                game.isPaused = false;
            };
            
            // Buy Coins button
            document.getElementById('buyCoinsBtn').onclick = () => {
                document.getElementById('coinPurchaseModal').style.display = 'flex';
            };
            
            document.getElementById('closeCoinPurchaseBtn').onclick = () => {
                document.getElementById('coinPurchaseModal').style.display = 'none';
            };
            
            // Skin selector
            document.getElementById('skinBtn').onclick = () => {
                const wasPlaying = !game.isPaused;
                game.isPaused = true;
                
                document.getElementById('currentSkinIcon').textContent = game.currentSkin;
                loadOwnedSkins();
                document.getElementById('skinModal').style.display = 'flex';
            };
            
            document.getElementById('closeSkinBtn').onclick = () => {
                document.getElementById('skinModal').style.display = 'none';
                // Resume if was playing
                if (!game.isGameOver) {
                    game.isPaused = false;
                    gameLoop();
                    spawnItems();
                }
            };
            
            // Play again
            document.getElementById('playAgainBtn').onclick = () => {
                document.getElementById('gameOver').style.display = 'none';
                resetGame();
                game.isPaused = false;
                game.isGameOver = false;
                gameLoop();
                spawnItems();
            };
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') moveCart(-1);
                if (e.key === 'ArrowRight') moveCart(1);
                if (e.key === ' ' || e.key === 'p') {
                    if (!game.isPaused && !game.isGameOver) {
                        game.isPaused = true;
                        document.getElementById('pauseMenu').style.display = 'flex';
                    }
                }
            });
        }

        // Load collection display
        function loadCollection() {
            const cartSkins = shopItems.filter(item => !item.type && !item.state && !item.special);
            const stateSkins = shopItems.filter(item => item.state);
            const specialSkins = shopItems.filter(item => item.special);
            
            // Calculate progress
            const totalItems = shopItems.filter(item => !item.type).length;
            const ownedItems = shopItems.filter(item => !item.type && item.owned).length;
            const progress = (ownedItems / totalItems) * 100;
            
            document.getElementById('collectionCount').textContent = ownedItems;
            document.getElementById('collectionTotal').textContent = totalItems;
            document.getElementById('collectionProgress').style.width = progress + '%';
            
            // Display cart skins
            const cartContainer = document.getElementById('cartCollection');
            cartContainer.innerHTML = '';
            cartSkins.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: ${item.owned ? 
                        'linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2))' : 
                        'rgba(0,0,0,0.5)'};
                    border: 2px solid ${item.owned ? '#FFD700' : '#333'};
                    border-radius: 10px;
                    padding: 8px;
                    text-align: center;
                    position: relative;
                    min-height: 80px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    transition: transform 0.2s;
                `;
                
                if (item.owned) {
                    div.innerHTML = `
                        <div style="font-size: 28px;">${item.icon}</div>
                        <div style="color: #FFD700; font-size: 9px; margin-top: 5px;">${item.name}</div>
                        <div style="position: absolute; top: 2px; right: 2px; color: #00FF00; font-size: 10px;">‚úì</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="font-size: 24px; opacity: 0.3;">üîí</div>
                        <div style="color: #666; font-size: 9px; margin-top: 5px;">${item.name}</div>
                        <div style="color: #FFD700; font-size: 8px;">${item.price}üí∞</div>
                    `;
                    div.style.cursor = 'pointer';
                    div.onclick = () => {
                        document.getElementById('profileModal').style.display = 'none';
                        document.getElementById('shopModal').classList.add('active');
                        loadShopItems();
                    };
                }
                
                div.onmouseover = () => div.style.transform = 'scale(1.05)';
                div.onmouseout = () => div.style.transform = 'scale(1)';
                
                cartContainer.appendChild(div);
            });
            
            // Display state skins
            const stateContainer = document.getElementById('stateCollection');
            stateContainer.innerHTML = '';
            stateSkins.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: ${item.owned ? 
                        'linear-gradient(135deg, rgba(0,40,104,0.3), rgba(191,10,48,0.3))' : 
                        'rgba(0,0,0,0.5)'};
                    border: 2px solid ${item.owned ? '#FFD700' : '#333'};
                    border-radius: 10px;
                    padding: 8px;
                    text-align: center;
                    position: relative;
                    min-height: 80px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    transition: transform 0.2s;
                `;
                
                if (item.owned) {
                    div.innerHTML = `
                        <div style="font-size: 28px;">${item.icon}</div>
                        <div style="color: #FFD700; font-size: 9px; margin-top: 5px;">${item.state}</div>
                        <div style="position: absolute; top: 2px; right: 2px; color: #00FF00; font-size: 10px;">‚úì</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="font-size: 20px; opacity: 0.2;">üè¥</div>
                        <div style="color: #666; font-size: 9px; margin-top: 5px;">${item.state}</div>
                        <div style="color: #FFD700; font-size: 8px;">${item.price}üí∞</div>
                    `;
                    div.style.cursor = 'pointer';
                    div.onclick = () => {
                        document.getElementById('profileModal').style.display = 'none';
                        document.getElementById('shopModal').classList.add('active');
                        loadShopItems();
                    };
                }
                
                div.onmouseover = () => div.style.transform = 'scale(1.05)';
                div.onmouseout = () => div.style.transform = 'scale(1)';
                
                stateContainer.appendChild(div);
            });
            
            // Display special skins
            const specialContainer = document.getElementById('specialCollection');
            specialContainer.innerHTML = '';
            specialSkins.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: ${item.owned ? 
                        'linear-gradient(135deg, rgba(155,89,182,0.3), rgba(231,76,60,0.3))' : 
                        'rgba(0,0,0,0.5)'};
                    border: 2px solid ${item.owned ? '#FFD700' : '#333'};
                    border-radius: 10px;
                    padding: 8px;
                    text-align: center;
                    position: relative;
                    min-height: 80px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    transition: transform 0.2s;
                `;
                
                if (item.owned) {
                    div.innerHTML = `
                        <div style="font-size: 28px;">${item.icon}</div>
                        <div style="color: #FFD700; font-size: 9px; margin-top: 5px;">${item.name}</div>
                        <div style="position: absolute; top: 2px; right: 2px; color: #00FF00; font-size: 10px;">‚úì</div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="font-size: 24px; opacity: 0.3;">üéÅ</div>
                        <div style="color: #666; font-size: 9px; margin-top: 5px;">${item.name}</div>
                        <div style="color: #FFD700; font-size: 8px;">${item.price}üí∞</div>
                    `;
                    div.style.cursor = 'pointer';
                    div.onclick = () => {
                        document.getElementById('profileModal').style.display = 'none';
                        document.getElementById('shopModal').classList.add('active');
                        loadShopItems();
                    };
                }
                
                div.onmouseover = () => div.style.transform = 'scale(1.05)';
                div.onmouseout = () => div.style.transform = 'scale(1)';
                
                specialContainer.appendChild(div);
            });
            
            // Display power-ups
            const powerupContainer = document.getElementById('powerupCollection');
            powerupContainer.innerHTML = '';
            const powerups = [
                { name: 'Shield', icon: 'üõ°Ô∏è', count: game.powerups.shield },
                { name: 'Magnet', icon: 'üß≤', count: game.powerups.magnet },
                { name: 'Double', icon: 'x2', count: game.powerups.double },
                { name: 'Vacuum', icon: 'üå™Ô∏è', count: game.powerups.vacuum || 0 }
            ];
            
            powerups.forEach(powerup => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
                    border: 2px solid #FFD700;
                    border-radius: 10px;
                    padding: 10px;
                    text-align: center;
                `;
                
                div.innerHTML = `
                    <div style="font-size: 24px;">${powerup.icon}</div>
                    <div style="color: white; font-size: 10px; margin: 5px 0;">${powerup.name}</div>
                    <div style="color: #FFD700; font-size: 16px; font-weight: bold;">${powerup.count}</div>
                `;
                
                powerupContainer.appendChild(div);
            });
        }

        // Purchase coins with Stripe (placeholder for demo)
        function purchaseCoins(amount, price) {
            // In production, this would integrate with Stripe Checkout
            // For demo, we'll simulate the purchase
            
            if (confirm(`Purchase ${amount.toLocaleString()} coins for $${price}?\n\nDemo Mode: No real charge will be made.`)) {
                // Simulate successful purchase
                game.coins += amount;
                game.stats.totalCoins += amount;
                
                // Update UI
                updateUI();
                document.getElementById('shopCoins').textContent = game.coins;
                
                // Close purchase modal
                document.getElementById('coinPurchaseModal').style.display = 'none';
                
                // Show success message
                showAchievement({ name: `Purchased ${amount.toLocaleString()} coins! üí∞` });
                
                // Save data
                saveGameData();
                
                // In production, this would be the Stripe integration:
                /*
                const stripe = Stripe('your-publishable-key');
                stripe.redirectToCheckout({
                    lineItems: [{
                        price: 'price_id_for_coin_package',
                        quantity: 1
                    }],
                    mode: 'payment',
                    successUrl: window.location.origin + '/success',
                    cancelUrl: window.location.origin + '/cancel'
                });
                */
            }
        }

        // Apply cart skin
        function applyCartSkin(skin) {
            const cart = document.getElementById('cart');
            cart.textContent = skin.icon || skin;
            game.currentSkin = skin.icon || skin;
            
            // Apply special classes for different skin types
            cart.className = ''; // Reset classes
            if (skin.state) {
                cart.classList.add('state-flag');
            } else if (skin.special) {
                cart.classList.add('special-edition');
            }
            
            // Save current skin
            localStorage.setItem('currentSkin', JSON.stringify(skin));
        }
        
        // Load owned skins
        function loadOwnedSkins() {
            const container = document.getElementById('ownedSkins');
            container.innerHTML = '';
            
            const ownedSkins = shopItems.filter(item => item.owned && !item.type);
            
            ownedSkins.forEach(skin => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: ${skin.icon === game.currentSkin ? 
                        'linear-gradient(135deg, #FFD700, #FFA500)' : 
                        'rgba(255,255,255,0.1)'};
                    border: 2px solid ${skin.icon === game.currentSkin ? '#00FF00' : '#FFD700'};
                    border-radius: 10px;
                    padding: 10px;
                    text-align: center;
                    cursor: pointer;
                    transition: transform 0.2s;
                `;
                
                div.innerHTML = `
                    <div style="font-size: 32px;">${skin.icon}</div>
                    <div style="color: white; font-size: 9px; margin-top: 5px;">${skin.name}</div>
                    ${skin.icon === game.currentSkin ? '<div style="color: #00FF00; font-size: 8px;">‚úì Active</div>' : ''}
                `;
                
                div.onclick = () => {
                    applyCartSkin(skin);
                    document.getElementById('currentSkinIcon').textContent = skin.icon;
                    loadOwnedSkins(); // Refresh display
                    showAchievement({ name: `Equipped: ${skin.name}!` });
                };
                
                div.onmouseover = () => {
                    div.style.transform = 'scale(1.1)';
                };
                
                div.onmouseout = () => {
                    div.style.transform = 'scale(1)';
                };
                
                container.appendChild(div);
            });
        }

        // Load shop items
        function loadShopItems() {
            const container = document.getElementById('shopItems');
            container.innerHTML = '';
            
            shopItems.forEach(item => {
                const div = document.createElement('div');
                div.style.background = 'rgba(255,255,255,0.1)';
                
                // Add rarity colors
                const rarityColors = {
                    common: '#888',
                    rare: '#4A90E2',
                    epic: '#9B59B6',
                    legendary: '#FFD700',
                    seasonal: '#E74C3C'
                };
                
                const borderColor = item.owned ? '#00FF00' : (rarityColors[item.rarity] || '#FFD700');
                div.style.border = `2px solid ${borderColor}`;
                div.style.borderRadius = '10px';
                div.style.padding = '10px';
                div.style.textAlign = 'center';
                div.style.cursor = 'pointer';
                
                div.innerHTML = `
                    <div style="font-size: 24px;">${item.icon}</div>
                    <div style="color: white; font-size: 10px; margin: 5px 0;">${item.name}</div>
                    ${item.rarity ? `<div style="color: ${borderColor}; font-size: 9px; font-style: italic;">${item.rarity}</div>` : ''}
                    <div style="color: #FFD700; font-size: 12px;">${item.owned ? '‚úì Owned' : item.price + 'üí∞'}</div>
                `;
                
                div.onclick = () => {
                    if (!item.owned && game.stats.totalCoins >= item.price) {
                        if (item.type === 'powerup') {
                            // Buy powerup pack
                            const powerupType = item.id.split('_')[1];
                            game.powerups[powerupType] += 3;
                            game.stats.totalCoins -= item.price;
                            updatePowerupInventory();
                            saveGameData();
                            loadShopItems();
                        } else if (!item.type) {
                            // Buy skin
                            item.owned = true;
                            game.stats.totalCoins -= item.price;
                            applyCartSkin(item); // Use the new applyCartSkin function
                            document.getElementById('shopPreviewCart').textContent = item.icon;
                            saveGameData();
                            loadShopItems();
                            
                            // Show purchase confirmation
                            showAchievement({ name: `Purchased: ${item.name}!` });
                        }
                    } else if (item.owned && !item.type) {
                        // Equip skin
                        applyCartSkin(item);
                        document.getElementById('shopPreviewCart').textContent = item.icon;
                        showAchievement({ name: `Equipped: ${item.name}!` });
                    }
                };
                
                container.appendChild(div);
            });
        }

        // Open Streak Modal
        function openStreakModal() {
            const modal = document.getElementById('streakModal');
            modal.style.display = 'flex';
            
            // Update UI
            document.getElementById('currentStreak').innerText = DailyStreakManager.streak.current;
            document.getElementById('longestStreak').innerText = DailyStreakManager.streak.longest;
            document.getElementById('totalLogins').innerText = DailyStreakManager.streak.totalLogins;
            
            // Display daily gifts
            const giftsContainer = document.getElementById('dailyGifts');
            giftsContainer.innerHTML = '';
            
            DailyStreakManager.streak.gifts.slice(0, 30).forEach(gift => {
                const giftDiv = document.createElement('div');
                giftDiv.style.cssText = `
                    background: ${gift.claimed ? 'rgba(0,0,0,0.5)' : gift.available ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'rgba(255,255,255,0.1)'};
                    border-radius: 10px;
                    padding: 8px;
                    text-align: center;
                    cursor: ${gift.available && !gift.claimed ? 'pointer' : 'default'};
                    position: relative;
                `;
                
                const icon = gift.type === 'coins' ? 'üí∞' : gift.type === 'gems' ? 'üíé' : gift.type === 'powerup' ? '‚ö°' : 'üé®';
                giftDiv.innerHTML = `
                    <div style="font-size: 20px;">${icon}</div>
                    <div style="color: white; font-size: 10px;">Day ${gift.day}</div>
                    <div style="color: white; font-size: 9px; font-weight: bold;">${gift.amount}</div>
                    ${gift.claimed ? '<div style="position: absolute; top: 0; right: 0; font-size: 12px;">‚úì</div>' : ''}
                `;
                
                if (gift.available && !gift.claimed) {
                    giftDiv.addEventListener('click', () => {
                        const claimed = DailyStreakManager.claimGift(gift.day);
                        if (claimed) {
                            saveGameData();
                            updateUI();
                            openStreakModal(); // Refresh modal
                            showAchievement(`Gift Claimed!`, `+${claimed.amount} ${claimed.type}`);
                        }
                    });
                }
                
                giftsContainer.appendChild(giftDiv);
            });
            
            // Display streak milestones
            const rewardsContainer = document.getElementById('streakRewards');
            rewardsContainer.innerHTML = '';
            
            DailyStreakManager.streak.milestones.forEach(milestone => {
                const milestoneDiv = document.createElement('div');
                const unlocked = DailyStreakManager.streak.current >= milestone.days;
                milestoneDiv.style.cssText = `
                    background: ${milestone.claimed ? 'rgba(0,0,0,0.5)' : unlocked ? 'linear-gradient(135deg, #667EEA, #764BA2)' : 'rgba(255,255,255,0.1)'};
                    border-radius: 10px;
                    padding: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: ${unlocked && !milestone.claimed ? 'pointer' : 'default'};
                `;
                
                milestoneDiv.innerHTML = `
                    <div>
                        <div style="color: white; font-weight: bold;">üèÜ ${milestone.days} Day Streak</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 12px;">
                            ${milestone.rewards.coins ? `üí∞ ${milestone.rewards.coins} coins` : ''}
                            ${milestone.rewards.gems ? ` üíé ${milestone.rewards.gems} gems` : ''}
                            ${milestone.rewards.skin ? ` üé® Exclusive skin` : ''}
                        </div>
                    </div>
                    <button style="background: ${milestone.claimed ? 'gray' : unlocked ? '#FFD700' : 'rgba(255,255,255,0.2)'}; 
                            color: ${unlocked ? '#333' : 'white'}; 
                            border: none; padding: 5px 10px; border-radius: 5px;
                            cursor: ${unlocked && !milestone.claimed ? 'pointer' : 'default'};">
                        ${milestone.claimed ? 'Claimed' : unlocked ? 'Claim' : `üîí ${milestone.days - DailyStreakManager.streak.current} days`}
                    </button>
                `;
                
                if (unlocked && !milestone.claimed) {
                    milestoneDiv.querySelector('button').addEventListener('click', () => {
                        milestone.claimed = true;
                        if (milestone.rewards.coins) {
                            game.coins += milestone.rewards.coins;
                        }
                        if (milestone.rewards.gems) {
                            game.gems = (game.gems || 0) + milestone.rewards.gems;
                        }
                        if (milestone.rewards.skin) {
                            if (!game.ownedSkins) game.ownedSkins = [];
                            game.ownedSkins.push(milestone.rewards.skin);
                        }
                        DailyStreakManager.save();
                        saveGameData();
                        updateUI();
                        openStreakModal();
                        showAchievement('Milestone Claimed!', `${milestone.days} day streak reward!`);
                    });
                }
                
                rewardsContainer.appendChild(milestoneDiv);
            });
            
            document.getElementById('closeStreakBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }
        
        // Open Season Modal
        function openSeasonModal() {
            const modal = document.getElementById('seasonModal');
            modal.style.display = 'flex';
            
            const season = SeasonPassManager.season;
            
            // Update season info
            document.getElementById('seasonName').innerText = season.name;
            document.getElementById('seasonDesc').innerText = season.description;
            
            // Calculate days remaining
            const daysLeft = Math.ceil((season.endDate - new Date()) / (1000 * 60 * 60 * 24));
            document.getElementById('seasonTimer').innerText = `${daysLeft} days`;
            
            // Update progress
            document.getElementById('currentTier').innerText = season.currentTier;
            document.getElementById('totalTiers').innerText = season.tiers.length;
            document.getElementById('seasonExp').innerText = season.experience;
            document.getElementById('seasonExpNext').innerText = season.experienceToNext;
            
            const progress = (season.experience / season.experienceToNext) * 100;
            document.getElementById('seasonProgress').style.width = progress + '%';
            
            // Display tiers
            const tiersContainer = document.getElementById('seasonTiers');
            let showPremium = false;
            
            const displayTiers = () => {
                tiersContainer.innerHTML = '';
                
                season.tiers.forEach(tier => {
                    const tierDiv = document.createElement('div');
                    tierDiv.style.cssText = `
                        background: ${tier.unlocked ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.3)'};
                        border-radius: 10px;
                        padding: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    `;
                    
                    const rewards = showPremium ? tier.premiumRewards : tier.freeRewards;
                    const rewardText = rewards.map(r => 
                        r.type === 'coins' ? `üí∞ ${r.amount}` : 
                        r.type === 'gems' ? `üíé ${r.amount}` : 
                        r.type === 'powerup' ? '‚ö° Power-up' : 
                        r.type === 'skin' ? 'üé® Skin' : ''
                    ).join(' ');
                    
                    tierDiv.innerHTML = `
                        <div>
                            <div style="color: ${tier.unlocked ? '#FFD700' : 'rgba(255,255,255,0.5)'}; font-weight: bold;">Tier ${tier.level}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 12px;">${rewardText}</div>
                        </div>
                        <button style="background: ${tier.claimed ? 'gray' : tier.unlocked ? '#FFD700' : 'rgba(255,255,255,0.2)'};
                                color: ${tier.unlocked ? '#333' : 'white'};
                                border: none; padding: 5px 10px; border-radius: 5px;
                                cursor: ${tier.unlocked && !tier.claimed ? 'pointer' : 'default'};">
                            ${tier.claimed ? 'Claimed' : tier.unlocked ? 'Claim' : `üîí ${tier.experienceRequired} XP`}
                        </button>
                    `;
                    
                    if (tier.unlocked && !tier.claimed) {
                        tierDiv.querySelector('button').addEventListener('click', () => {
                            const claimed = SeasonPassManager.claimTierRewards(tier.level);
                            if (claimed) {
                                updateUI();
                                openSeasonModal();
                                showAchievement('Rewards Claimed!', `Tier ${tier.level} rewards`);
                            }
                        });
                    }
                    
                    tiersContainer.appendChild(tierDiv);
                });
            };
            
            displayTiers();
            
            // Tab buttons
            document.getElementById('freeRewardsBtn').onclick = () => {
                showPremium = false;
                document.getElementById('freeRewardsBtn').style.background = 'rgba(255,255,255,0.2)';
                document.getElementById('premiumRewardsBtn').style.background = 'rgba(255,255,255,0.1)';
                displayTiers();
            };
            
            document.getElementById('premiumRewardsBtn').onclick = () => {
                if (!season.premium) {
                    if (confirm('Upgrade to Premium Pass for $4.99 to unlock exclusive rewards?')) {
                        SeasonPassManager.upgradeToPremium();
                        openSeasonModal();
                    }
                    return;
                }
                showPremium = true;
                document.getElementById('premiumRewardsBtn').style.background = 'rgba(255,255,255,0.2)';
                document.getElementById('freeRewardsBtn').style.background = 'rgba(255,255,255,0.1)';
                displayTiers();
            };
            
            // Upgrade button
            document.getElementById('upgradePremiumBtn').onclick = () => {
                if (!season.premium) {
                    if (confirm('Upgrade to Premium Pass for $4.99?\n\n‚úì Exclusive skins\n‚úì 5x more rewards\n‚úì Special power-ups')) {
                        SeasonPassManager.upgradeToPremium();
                        openSeasonModal();
                    }
                } else {
                    showAchievement('Already Premium!', 'Enjoy your exclusive rewards!');
                }
            };
            
            if (season.premium) {
                document.getElementById('upgradePremiumBtn').innerText = '‚úì Premium Active';
                document.getElementById('upgradePremiumBtn').style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                document.getElementById('premiumRewardsBtn').innerHTML = 'Premium Rewards üåü';
            }
            
            document.getElementById('closeSeasonBtn').onclick = () => {
                modal.style.display = 'none';
            };
        }

        // Start the game
        window.onload = init;
    </script>
</body>
</html>